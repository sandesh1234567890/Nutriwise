<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NutriWise - AI Health Companion</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        
        .app-container {
            max-width: 450px;
            margin: 0 auto;
            background-color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Custom Gradients */
        .bg-gradient-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-gradient-danger { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }
        .bg-gradient-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const apiKey = "AIzaSyDSjtDzKPvIxkspiKTjrcB79HHdsCAMNh4"; // Runtime provided

        // --- Icons ---
        const Icon = ({ size = 24, color = "currentColor", children, className = "", onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const HomeIcon = (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>;
        const HistoryIcon = (p) => <Icon {...p}><path d="M12 20v-6M6 20V10M18 20V4"/></Icon>; 
        const UserIcon = (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const CameraIcon = (p) => <Icon {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>;
        const LeafIcon = (p) => <Icon {...p}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></Icon>;
        const ArrowLeft = (p) => <Icon {...p}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></Icon>;
        const X = (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 18 12"/></Icon>;
        const Send = (p) => <Icon {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>;
        const Target = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></Icon>;
        const Scale = (p) => <Icon {...p}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></Icon>;
        const ImageIcon = (p) => <Icon {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></Icon>;
        const Zap = (p) => <Icon {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>;
        const CheckSquare = (p) => <Icon {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></Icon>;
        const Flame = (p) => <Icon {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></Icon>;

        // --- Utils ---
        const saveToStorage = (key, data) => {
            try { localStorage.setItem(key, JSON.stringify(data)); } 
            catch (e) { console.error("Storage full"); }
        };
        const getFromStorage = (key) => {
            try { return JSON.parse(localStorage.getItem(key)); } catch (e) { return null; }
        };

        // --- Components ---

        const ChallengeCard = ({ title, type, checked, onToggle }) => (
            <div 
                onClick={onToggle}
                className={`flex items-center justify-between p-4 rounded-xl border-2 transition-all cursor-pointer ${
                    checked 
                    ? 'bg-green-50 border-green-500 shadow-none' 
                    : 'bg-white border-gray-100 shadow-sm hover:border-green-200'
                }`}
            >
                <div className="flex items-center gap-4">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                        type === 'exercise' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'
                    }`}>
                        {type === 'exercise' ? <Flame size={20}/> : <Zap size={20}/>}
                    </div>
                    <div>
                        <h4 className={`font-bold text-sm ${checked ? 'text-green-800 line-through opacity-70' : 'text-gray-800'}`}>{title}</h4>
                        <p className="text-[10px] text-gray-500">{type === 'exercise' ? 'Activity' : 'Habit'}</p>
                    </div>
                </div>
                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                    checked ? 'bg-green-500 border-green-500' : 'border-gray-300'
                }`}>
                    {checked && <Icon size={14} color="white"><polyline points="20 6 9 17 4 12"/></Icon>}
                </div>
            </div>
        );

        const ConditionSelector = ({ selected = [], onChange }) => {
            const options = [
                { id: 'diabetes', label: 'Diabetes' },
                { id: 'bp', label: 'High BP' },
                { id: 'weightloss', label: 'Fat Loss' },
                { id: 'muscle', label: 'Muscle Gain' }
            ];

            const toggle = (id) => {
                if (selected.includes(id)) {
                    onChange(selected.filter(item => item !== id));
                } else {
                    onChange([...selected, id]);
                }
            };

            return (
                <div className="flex flex-wrap gap-2">
                    {options.map(opt => (
                        <button
                            key={opt.id}
                            onClick={() => toggle(opt.id)}
                            className={`px-4 py-2 rounded-xl text-sm font-bold border-2 transition-all ${
                                selected.includes(opt.id)
                                    ? 'bg-green-500 text-white border-green-500 shadow-md'
                                    : 'bg-white text-gray-600 border-gray-100 hover:border-gray-200'
                            }`}
                        >
                            {opt.label}
                        </button>
                    ))}
                </div>
            );
        };

        // 1. Camera View
        const CameraView = ({ onCapture, onClose }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                let stream = null;
                const startCamera = async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                        if (videoRef.current) videoRef.current.srcObject = stream;
                    } catch (err) {
                        setError("Camera unavailable");
                    }
                };
                startCamera();
                return () => { if (stream) stream.getTracks().forEach(track => track.stop()); };
            }, []);

            const processAndCapture = (sourceType) => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let width, height, drawSource;

                if (sourceType === 'video' && videoRef.current) {
                    drawSource = videoRef.current;
                    width = videoRef.current.videoWidth;
                    height = videoRef.current.videoHeight;
                } else { return; }

                const MAX_SIZE = 500;
                let scale = width > MAX_SIZE || height > MAX_SIZE ? Math.min(MAX_SIZE / width, MAX_SIZE / height) : 1;
                canvas.width = width * scale;
                canvas.height = height * scale;
                ctx.drawImage(drawSource, 0, 0, canvas.width, canvas.height);
                onCapture(canvas.toDataURL('image/jpeg', 0.8));
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = canvasRef.current;
                            const ctx = canvas.getContext('2d');
                            const MAX_SIZE = 500;
                            let w = img.width, h = img.height;
                            let s = w > MAX_SIZE || h > MAX_SIZE ? Math.min(MAX_SIZE / w, MAX_SIZE / h) : 1;
                            canvas.width = w * s; canvas.height = h * s;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            onCapture(canvas.toDataURL('image/jpeg', 0.8));
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col fade-in">
                    <div className="relative flex-1 bg-black flex items-center justify-center overflow-hidden">
                        {error ? (
                            <div className="text-white text-center p-4">
                                <p className="mb-4 text-red-400 font-bold">{error}</p>
                                <button onClick={() => fileInputRef.current.click()} className="bg-white text-black px-6 py-3 rounded-full font-bold flex items-center gap-2 mx-auto">
                                    <ImageIcon size={20}/> Upload Photo
                                </button>
                            </div>
                        ) : (
                            <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover opacity-90"></video>
                        )}
                        <canvas ref={canvasRef} className="hidden"></canvas>
                        <input type="file" ref={fileInputRef} accept="image/*" className="hidden" onChange={handleFileUpload} />
                        
                        <div className="absolute top-0 left-0 w-full p-6 flex justify-between z-10">
                            <button onClick={onClose} className="text-white bg-black/40 backdrop-blur-md p-3 rounded-full">
                                <X size={24} />
                            </button>
                        </div>
                    </div>

                    <div className="h-36 bg-black flex items-center justify-center gap-12 pb-6">
                        <button onClick={() => fileInputRef.current.click()} className="p-4 bg-gray-900 rounded-full text-white border border-gray-800">
                            <ImageIcon size={24} />
                        </button>
                        <button 
                            onClick={() => !error && processAndCapture('video')}
                            className={`w-20 h-20 rounded-full border-4 border-white flex items-center justify-center transition active:scale-90 ${error ? 'opacity-50' : 'bg-white/10'}`}
                            disabled={!!error}
                        >
                            <div className="w-16 h-16 bg-white rounded-full"></div>
                        </button>
                        <div className="w-12"></div>
                    </div>
                </div>
            );
        };

        // 2. Chat Component
        const ChatBot = ({ profile, scanResult, onClose }) => {
            const [messages, setMessages] = useState([
                { sender: 'bot', text: `Hi! I'm Dr. NutriWise. I see you scanned ${scanResult?.name || 'food'}. Ask me about portions for your ${profile.weight}kg weight!` }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => scrollRef.current?.scrollIntoView({ behavior: "smooth" }), [messages, loading]);

            const handleSend = async () => {
                if (!input.trim()) return;
                const userText = input;
                setMessages(prev => [...prev, { sender: 'user', text: userText }]);
                setInput('');
                setLoading(true);

                try {
                    const conditions = profile.conditions.join(', ') || "None";
                    const prompt = `
                        You are Dr. NutriWise. Reply in short, plain text. No markdown (**bold**, etc).
                        User: ${profile.weight}kg, ${profile.age}yo. Conditions: ${conditions}.
                        Food Context: ${scanResult?.name} (${scanResult?.calories}).
                        Question: "${userText}"
                        Answer as a strict but kind doctor. Be specific about portion sizes in grams.
                    `;

                    // Only send text context for speed, unless absolutely needed
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    const data = await response.json();
                    let aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Connection error.";
                    // Strip any accidental markdown
                    aiText = aiText.replace(/\*\*/g, "").replace(/\*/g, ""); 
                    
                    setMessages(prev => [...prev, { sender: 'bot', text: aiText }]);
                } catch (e) {
                    setMessages(prev => [...prev, { sender: 'bot', text: "I'm having trouble connecting. Try again." }]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-50 z-50 flex flex-col slide-up">
                    <div className="p-4 bg-white border-b flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600"><UserIcon size={20}/></div>
                            <div>
                                <h3 className="font-bold text-gray-800">Dr. NutriWise</h3>
                                <div className="flex items-center gap-1">
                                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <p className="text-xs text-gray-500">Online</p>
                                </div>
                            </div>
                        </div>
                        <button onClick={onClose} className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full"><X size={20}/></button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed ${
                                    m.sender === 'user' 
                                    ? 'bg-black text-white rounded-tr-sm' 
                                    : 'bg-white border border-gray-100 shadow-sm text-gray-700 rounded-tl-sm'
                                }`}>
                                    {m.text}
                                </div>
                            </div>
                        ))}
                        {loading && (
                            <div className="flex justify-start">
                                <div className="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 flex gap-1.5">
                                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                    <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                </div>
                            </div>
                        )}
                        <div ref={scrollRef} />
                    </div>

                    <div className="p-4 bg-white border-t">
                        <div className="flex items-center gap-2 bg-gray-100 rounded-full px-4 py-2">
                            <input 
                                className="flex-1 bg-transparent outline-none text-sm py-2"
                                placeholder="Ask a question..."
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && handleSend()}
                            />
                            <button onClick={handleSend} className="w-8 h-8 bg-black rounded-full flex items-center justify-center text-white shadow-lg disabled:opacity-50" disabled={!input.trim()}>
                                <Send size={16} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Tab Screens

        const PlanTab = ({ profile }) => {
            // Simple persistent state for checkboxes
            const [challenges, setChallenges] = useState(() => {
                const saved = getFromStorage('nutri_challenges');
                return saved || {
                    water: false,
                    sugar: false,
                    walk: false,
                    veggie: false
                };
            });

            const toggleChallenge = (key) => {
                const newCh = { ...challenges, [key]: !challenges[key] };
                setChallenges(newCh);
                saveToStorage('nutri_challenges', newCh);
            };

            const completedCount = Object.values(challenges).filter(Boolean).length;
            const progress = (completedCount / 4) * 100;

            return (
                <div className="p-5 pb-24 space-y-8">
                    <div className="flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900">Today's Plan</h2>
                            <p className="text-sm text-gray-500">Let's hit your goals!</p>
                        </div>
                        <div className="text-right">
                            <span className="text-2xl font-bold text-green-600">{completedCount}/4</span>
                            <p className="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Completed</p>
                        </div>
                    </div>

                    {/* Progress Bar */}
                    <div className="w-full bg-gray-100 rounded-full h-3">
                        <div className="bg-green-500 h-3 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
                    </div>

                    {/* Challenges List */}
                    <div>
                        <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Daily Habits</h3>
                        <div className="space-y-3">
                            <ChallengeCard 
                                title="No Added Sugar" 
                                type="habit" 
                                checked={challenges.sugar} 
                                onToggle={() => toggleChallenge('sugar')}
                            />
                            <ChallengeCard 
                                title="Eat 1 Bowl of Veggies" 
                                type="habit" 
                                checked={challenges.veggie} 
                                onToggle={() => toggleChallenge('veggie')}
                            />
                        </div>
                    </div>

                    <div>
                        <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Activity</h3>
                        <div className="space-y-3">
                            <ChallengeCard 
                                title="30 Minute Brisk Walk" 
                                type="exercise" 
                                checked={challenges.walk} 
                                onToggle={() => toggleChallenge('walk')}
                            />
                            <ChallengeCard 
                                title="Drink 3 Liters Water" 
                                type="habit" 
                                checked={challenges.water} 
                                onToggle={() => toggleChallenge('water')}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        const ProfileTab = ({ profile, onUpdate }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [localData, setLocalData] = useState(profile);

            return (
                <div className="p-5 pb-24">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-bold text-gray-900">My Profile</h2>
                        <button onClick={() => { if(isEditing) onUpdate(localData); setIsEditing(!isEditing); }} className="text-green-600 font-bold text-sm bg-green-50 px-4 py-2 rounded-lg">
                            {isEditing ? 'Save Changes' : 'Edit Profile'}
                        </button>
                    </div>

                    <div className="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 text-center mb-6">
                        <div className="w-24 h-24 bg-gradient-primary rounded-full flex items-center justify-center text-4xl font-bold text-white mx-auto mb-4 shadow-lg shadow-green-200">
                            {profile.name[0]}
                        </div>
                        {isEditing ? (
                            <input value={localData.name} onChange={e => setLocalData({...localData, name: e.target.value})} className="text-center font-bold text-xl border-b border-green-500 outline-none w-full" />
                        ) : (
                            <h3 className="text-xl font-bold text-gray-800">{profile.name}</h3>
                        )}
                        <p className="text-gray-400 text-sm mt-1">Health Warrior</p>
                    </div>

                    <div className="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 space-y-6">
                        <div className="flex gap-4">
                            <div className="flex-1 p-3 bg-gray-50 rounded-2xl">
                                <p className="text-xs text-gray-400 font-bold uppercase mb-1">Age</p>
                                {isEditing ? (
                                    <input type="number" value={localData.age} onChange={e => setLocalData({...localData, age: e.target.value})} className="bg-transparent font-bold text-lg w-full outline-none" />
                                ) : (
                                    <p className="font-bold text-xl text-gray-800">{profile.age}</p>
                                )}
                            </div>
                            <div className="flex-1 p-3 bg-gray-50 rounded-2xl">
                                <p className="text-xs text-gray-400 font-bold uppercase mb-1">Weight (kg)</p>
                                {isEditing ? (
                                    <input type="number" value={localData.weight} onChange={e => setLocalData({...localData, weight: e.target.value})} className="bg-transparent font-bold text-lg w-full outline-none" />
                                ) : (
                                    <p className="font-bold text-xl text-gray-800">{profile.weight}</p>
                                )}
                            </div>
                        </div>

                        <div>
                            <p className="text-xs text-gray-400 font-bold uppercase mb-3">Clinical Focus</p>
                            {isEditing ? (
                                <ConditionSelector selected={localData.conditions} onChange={c => setLocalData({...localData, conditions: c})} />
                            ) : (
                                <div className="flex flex-wrap gap-2">
                                    {profile.conditions.length > 0 ? profile.conditions.map(c => (
                                        <span key={c} className="bg-black text-white px-4 py-2 rounded-xl text-sm font-bold capitalize shadow-md">{c === 'bp' ? 'High BP' : c}</span>
                                    )) : <span className="text-gray-400">No specific conditions</span>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [screen, setScreen] = useState('onboard');
            const [activeTab, setActiveTab] = useState('home');
            const [profile, setProfile] = useState({ name: '', age: '', conditions: [], weight: '', targetWeight: '' });
            const [history, setHistory] = useState([]);
            const [currentScan, setCurrentScan] = useState(null);
            const [showChat, setShowChat] = useState(false);

            useEffect(() => {
                const p = getFromStorage('nutri_profile');
                const h = getFromStorage('nutri_history');
                if (p) {
                    if (!p.conditions) p.conditions = [];
                    setProfile(p);
                    setScreen('home');
                }
                if (h) setHistory(h);
            }, []);

            // Explicitly defining the handleProfileSave function here
            const handleProfileSave = (data) => {
                setProfile(data);
                saveToStorage('nutri_profile', data);
                if (screen === 'onboard') {
                    setScreen('home');
                }
            };

            const callGeminiAnalysis = async (prof, imgBase64) => {
                try {
                    const prompt = `
                    You are Dr. NutriWise. Analyze this food image.
                    User: ${prof.weight}kg, ${prof.age}yo. Conditions: ${prof.conditions.join(', ')}.
                    Return ONLY raw JSON (no markdown formatting, no stars).
                    Format:
                    {
                        "name": "Food Name",
                        "calories": "300",
                        "sugar": "Low/Med/High",
                        "fat": "10g",
                        "verdict": "Safe" or "Moderate" or "Avoid",
                        "msg": "Short clinical reason (max 15 words).",
                        "alt": "Short healthy alternative."
                    }
                    `;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imgBase64.split(',')[1] } }]
                            }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const data = await response.json();
                    return { ...JSON.parse(data.candidates[0].content.parts[0].text), id: Date.now(), date: new Date().toISOString(), img: imgBase64 };
                } catch (e) {
                    return { id: Date.now(), date: new Date().toISOString(), img: imgBase64, name: "Food Item", verdict: "Moderate", calories: "---", sugar: "---", msg: "Could not analyze. Please try again.", alt: "---" };
                }
            };

            const handleCapture = async (img) => {
                setScreen('result');
                const res = await callGeminiAnalysis(profile, img);
                setCurrentScan(res);
                const newH = [res, ...history];
                setHistory(newH);
                saveToStorage('nutri_history', newH);
            };

            // Onboarding
            if (screen === 'onboard') return (
                <div className="app-container p-8 flex flex-col justify-center bg-white">
                    <div className="flex-1 flex flex-col justify-center items-center text-center">
                        <div className="w-24 h-24 bg-gradient-primary rounded-3xl flex items-center justify-center text-white shadow-2xl mb-6 rotate-3">
                            <LeafIcon size={48} />
                        </div>
                        <h1 className="text-3xl font-extrabold text-gray-900 mb-2 tracking-tight">NutriWise</h1>
                        <p className="text-gray-500">Your Clinical AI Health Companion</p>
                    </div>
                    <div className="space-y-4 mb-8">
                        <input placeholder="Your Name" className="w-full p-4 bg-gray-50 rounded-2xl font-bold outline-none focus:ring-2 ring-green-100" value={profile.name} onChange={e=>setProfile({...profile, name: e.target.value})} />
                        <div className="flex gap-4">
                            <input type="number" placeholder="Age" className="w-1/2 p-4 bg-gray-50 rounded-2xl font-bold outline-none focus:ring-2 ring-green-100" value={profile.age} onChange={e=>setProfile({...profile, age: e.target.value})} />
                            <input type="number" placeholder="Weight (kg)" className="w-1/2 p-4 bg-gray-50 rounded-2xl font-bold outline-none focus:ring-2 ring-green-100" value={profile.weight} onChange={e=>setProfile({...profile, weight: e.target.value})} />
                        </div>
                        <p className="text-xs font-bold text-gray-400 uppercase mt-4">Health Goals</p>
                        <ConditionSelector selected={profile.conditions} onChange={c=>setProfile({...profile, conditions: c})} />
                    </div>
                    <button onClick={() => handleProfileSave(profile)} className="w-full bg-black text-white p-5 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-transform">Start Journey</button>
                </div>
            );

            if (screen === 'camera') return <CameraView onCapture={handleCapture} onClose={()=>setScreen('home')}/>;

            // Result Screen (Card UI)
            if (screen === 'result') return (
                <div className="app-container bg-gray-100 relative">
                    {!currentScan ? (
                        <div className="flex-1 flex flex-col items-center justify-center">
                            <div className="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                            <p className="mt-4 font-bold text-gray-500 animate-pulse">Analyzing...</p>
                        </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto pb-20 fade-in">
                            <div className="relative h-80 bg-gray-900">
                                <img src={currentScan.img} className="w-full h-full object-cover opacity-90" />
                                <div className="absolute top-4 left-4"><button onClick={()=>setScreen('home')} className="bg-white/20 backdrop-blur p-2 rounded-full text-white"><ArrowLeft/></button></div>
                                <div className="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black/90 to-transparent">
                                    <div className={`inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 ${
                                        currentScan.verdict === 'Safe' ? 'bg-green-500 text-white' : currentScan.verdict === 'Avoid' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-black'
                                    }`}>{currentScan.verdict}</div>
                                    <h1 className="text-3xl font-extrabold text-white leading-tight">{currentScan.name}</h1>
                                </div>
                            </div>
                            
                            <div className="p-6 -mt-6 rounded-t-3xl bg-gray-100 relative z-10 space-y-4">
                                {/* Fast Read Metrics */}
                                <div className="grid grid-cols-3 gap-3">
                                    {[
                                        { l: 'CALORIES', v: currentScan.calories }, 
                                        { l: 'SUGAR', v: currentScan.sugar }, 
                                        { l: 'FAT', v: currentScan.fat || 'N/A' }
                                    ].map((m,i) => (
                                        <div key={i} className="bg-white p-3 rounded-2xl shadow-sm text-center border border-gray-100">
                                            <p className="text-[10px] font-bold text-gray-400">{m.l}</p>
                                            <p className="text-lg font-black text-gray-800">{m.v}</p>
                                        </div>
                                    ))}
                                </div>

                                {/* Fast Read Analysis Cards */}
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex gap-4">
                                    <div className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 shrink-0"><Zap size={20}/></div>
                                    <div>
                                        <h3 className="font-bold text-gray-900 text-sm mb-1">Clinical Verdict</h3>
                                        <p className="text-sm text-gray-600 leading-snug">{currentScan.msg}</p>
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex gap-4">
                                    <div className="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-600 shrink-0"><LeafIcon size={20}/></div>
                                    <div>
                                        <h3 className="font-bold text-gray-900 text-sm mb-1">Better Alternative</h3>
                                        <p className="text-sm text-gray-600 leading-snug">{currentScan.alt}</p>
                                    </div>
                                </div>

                                <button onClick={()=>setShowChat(true)} className="w-full bg-black text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-xl active:scale-95 transition-transform">
                                    <Icon size={20}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>
                                    Ask Dr. NutriWise
                                </button>
                            </div>
                        </div>
                    )}
                    {showChat && <ChatBot profile={profile} scanResult={currentScan} onClose={()=>setShowChat(false)} />}
                </div>
            );

            // Dashboard
            return (
                <div className="app-container bg-gray-50 relative">
                    {activeTab === 'home' && (
                        <div className="p-6 pb-24 space-y-6 overflow-y-auto h-full no-scrollbar">
                            <div className="flex justify-between items-center pt-2">
                                <div>
                                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest">Welcome Back</p>
                                    <h1 className="text-2xl font-black text-gray-900">{profile.name}</h1>
                                </div>
                                <div onClick={()=>setActiveTab('profile')} className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-gray-900 border border-gray-200 shadow-sm cursor-pointer"><UserIcon size={20}/></div>
                            </div>

                            {/* Streak/Stats Card */}
                            <div className="bg-black text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                                <div className="relative z-10 flex justify-between items-end">
                                    <div>
                                        <p className="text-gray-400 text-xs font-bold uppercase mb-1">Daily Streak</p>
                                        <div className="flex items-baseline gap-1">
                                            <span className="text-4xl font-black">12</span>
                                            <span className="text-sm font-bold text-gray-500">days</span>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-green-400 font-bold text-sm">Target: 70kg</p>
                                        <p className="text-xs text-gray-500">Current: {profile.weight}kg</p>
                                    </div>
                                </div>
                                <div className="absolute top-0 right-0 w-32 h-32 bg-green-500 rounded-full blur-[60px] opacity-20"></div>
                            </div>

                            {/* Main Action */}
                            <div onClick={()=>setScreen('camera')} className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-4 cursor-pointer hover:border-green-300 transition-colors group">
                                <div className="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center text-green-600 group-hover:scale-110 transition-transform">
                                    <CameraIcon size={32}/>
                                </div>
                                <div className="text-center">
                                    <h3 className="font-bold text-gray-900">Scan Meal</h3>
                                    <p className="text-xs text-gray-500 mt-1">Get instant analysis</p>
                                </div>
                            </div>

                            {/* Recent */}
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-gray-900">Recent Scans</h3>
                                    <span className="text-xs font-bold text-green-600 cursor-pointer" onClick={()=>setActiveTab('history')}>View All</span>
                                </div>
                                <div className="space-y-3">
                                    {history.slice(0, 3).map((h, i) => (
                                        <div key={i} className="bg-white p-3 rounded-2xl flex items-center gap-4 shadow-sm border border-gray-100">
                                            <img src={h.img} className="w-12 h-12 rounded-xl object-cover" />
                                            <div className="flex-1">
                                                <h4 className="font-bold text-sm text-gray-800">{h.name}</h4>
                                                <p className="text-[10px] text-gray-400">{new Date(h.date).toLocaleDateString()}</p>
                                            </div>
                                            <div className={`text-[10px] font-bold px-2 py-1 rounded ${h.verdict==='Safe'?'bg-green-50 text-green-600':'bg-red-50 text-red-600'}`}>{h.verdict}</div>
                                        </div>
                                    ))}
                                    {history.length === 0 && <p className="text-center text-xs text-gray-400 py-4">No scans yet. Try scanning your lunch!</p>}
                                </div>
                            </div>
                        </div>
                    )}
                    {activeTab === 'plan' && <PlanTab profile={profile}/>}
                    {activeTab === 'history' && (
                        <div className="p-6 pb-24 overflow-y-auto h-full no-scrollbar">
                            <h2 className="text-2xl font-bold text-gray-900 mb-6">History</h2>
                            {history.map((h,i) => (
                                <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4 flex gap-4">
                                    <img src={h.img} className="w-16 h-16 rounded-xl object-cover" />
                                    <div>
                                        <h4 className="font-bold text-gray-900">{h.name}</h4>
                                        <p className="text-xs text-gray-500 mt-1">{h.calories} â€¢ {h.verdict}</p>
                                        <p className="text-[10px] text-gray-400 mt-2">{new Date(h.date).toDateString()}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {activeTab === 'profile' && <ProfileTab profile={profile} onUpdate={handleProfileSave}/>}

                    {/* Nav Bar */}
                    <div className="absolute bottom-0 w-full bg-white border-t border-gray-100 p-2 pb-6 flex justify-around shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-20">
                        {['home', 'plan', 'history', 'profile'].map(tab => (
                            <button key={tab} onClick={()=>setActiveTab(tab)} className={`p-3 rounded-2xl flex flex-col items-center gap-1 transition-all ${activeTab===tab ? 'text-green-600 bg-green-50' : 'text-gray-400 hover:bg-gray-50'}`}>
                                {tab==='home' && <HomeIcon size={22}/>}
                                {tab==='plan' && <CheckSquare size={22}/>}
                                {tab==='history' && <HistoryIcon size={22}/>}
                                {tab==='profile' && <UserIcon size={22}/>}
                                <span className="text-[9px] font-bold uppercase tracking-wide">{tab}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
